<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Admin Dashboard</title>
    <link href="/css/admin-dashboard.css" rel="stylesheet" />
</head>
<body>
    <div class="content-full">
        <div class="dashboard-card">
            <h2 class="admin-dashboard-header">Admin Dashboard</h2>
            <div class="admin-dashboard-buttons">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/admin/logging'">Logging Dashboard</button>
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/admin/banning'">Banning Dashboard</button>
            </div>
            <div class="full admin-dashboard-panel">
                <div class="card">
                    <h3 class="admin-dashboard-header">Banned IPs</h3>
                    <ul id="banned-ips-list" class="admin-dashboard-card-list"></ul>
                </div>
                <div class="card">
                    <h3 class="admin-dashboard-header">Registered IPs</h3>
                    <ul id="registered-ips-list" class="admin-dashboard-card-list"></ul>
                </div>
                <div class="card">
                    <h3 class="admin-dashboard-header">Pipeline Info</h3>
                    <ul id="pipeline-info-list" class="admin-dashboard-card-list"></ul>
                </div>
                <div class="card">
                    <h3 class="admin-dashboard-header">Memory Usage</h3>
                    <div id="memory-usage-info" class="admin-dashboard-memory">Loading...</div>
                </div>
            </div>
        </div>
        <script>
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            fetch('/api/metrics/dashboard-info')
                .then(res => res.json())
                .then(data => {
                    // Banned IPs
                    const bannedList = document.getElementById('banned-ips-list');
                    bannedList.innerHTML = '';
                    const bannedIPs = data.bannedIPs || {};
                    if (Object.keys(bannedIPs).length === 0) {
                        bannedList.innerHTML = '<li>None</li>';
                    } else {
                        for (const [ip, until] of Object.entries(bannedIPs)) {
                            bannedList.innerHTML += `<li>${escapeHtml(ip)} (until ${escapeHtml(until)})</li>`;
                        }
                    }

                    // Registered IPs
                    const regList = document.getElementById('registered-ips-list');
                    regList.innerHTML = '';
                    const regIPs = data.registeredIPs || {};
                    if (Object.keys(regIPs).length === 0) {
                        regList.innerHTML = '<li>None</li>';
                    } else {
                        for (const [ip, info] of Object.entries(regIPs)) {
                            regList.innerHTML += `<li>${escapeHtml(ip)}: ${escapeHtml(info)}</li>`;
                        }
                    }

                    // Pipeline Info
                    const pipeList = document.getElementById('pipeline-info-list');
                    pipeList.innerHTML = '';
                    const pipeInfo = data.pipelineInfo || {};
                    if (Object.keys(pipeInfo).length === 0) {
                        pipeList.innerHTML = '<li>None</li>';
                    } else {
                        for (const [sessionId, meta] of Object.entries(pipeInfo)) {
                            pipeList.innerHTML += `<li>${escapeHtml(sessionId)}: ${escapeHtml(meta.estimatedMemoryUsageMB)}, created ${escapeHtml(meta.creationTime)}</li>`;
                        }
                    }

                    // Memory Usage
                    document.getElementById('memory-usage-info').textContent = data.memoryUsageInfo || 'N/A';
                })
                .catch(err => {
                    document.getElementById('memory-usage-info').textContent = 'Failed to load dashboard info.';
                });
        </script>
    </div>
</body>
</html>
